<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QRIS Scanner</title>
<style>
  body {
    margin:0; font-family:system-ui, sans-serif;
    background:#000; color:#fff;
  }
  .hidden { display:none !important; }

  /* Scanner */
  .scanner {
    position:fixed; inset:0; display:flex; flex-direction:column;
    background:#000;
  }
  .scanner-bar {
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 16px; background:rgba(0,0,0,.4);
  }
  .scanner-title { font-weight:600; font-size:16px; }
  .btn-icon {
    background:#222; border:0; width:42px; height:42px;
    border-radius:12px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:transform .15s ease;
  }
  .btn-icon:active { transform:scale(0.85); }
  .preview { flex:1; position:relative; display:grid; place-items:center; overflow:hidden; }
  video { width:100%; height:100%; object-fit:cover; }
  .scan-frame {
    position:absolute; width:72vw; max-width:340px; aspect-ratio:1/1;
    border:2px solid rgba(255,255,255,.6); border-radius:16px;
    box-shadow:0 0 0 2000px rgba(0,0,0,.55);
  }
  .scan-line {
    position:absolute; left:0; right:0; height:3px;
    background:#22d3ee; border-radius:2px;
    animation: scanMove 2s linear infinite;
  }
  @keyframes scanMove {
    0% { top:10%; }
    100% { top:90%; }
  }

  /* Payment UI */
  .payment-screen {
    position:fixed; inset:0; background:#f9fafb; color:#111; display:flex; flex-direction:column;
  }
  .payment-header {
    background:#0284c7; color:#fff; padding:16px;
    border-radius:0 0 16px 16px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
  }
  .payment-header h2 { margin:0; font-size:18px; }
  .payment-header p { margin:4px 0 0; font-size:14px; opacity:.9; }

  .payment-body {
    flex:1; padding:20px; display:flex; flex-direction:column; gap:16px;
  }
  .merchant-box {
    background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.05);
  }
  .merchant-name { font-size:16px; font-weight:600; }
  .merchant-price { font-size:22px; color:#f97316; font-weight:700; margin-top:8px; }
  .custom-input {
    margin-top:12px; padding:12px; font-size:16px; width:100%;
    border:2px solid #0284c7; border-radius:10px;
    outline:none; transition:border .2s;
  }
  .custom-input:focus { border-color:#0369a1; }

  .saldo-box {
    background:#f1f5f9; padding:12px; border-radius:8px; font-size:14px; color:#374151;
  }
  .btn-pay {
    background:#0284c7; color:#fff; border:0;
    padding:16px; border-radius:12px; font-size:16px; font-weight:600;
    cursor:pointer; transition:transform .15s ease, background .2s;
  }
  .btn-pay:active { transform:scale(0.95); }
  .btn-pay:disabled { background:#94a3b8; cursor:not-allowed; }

  /* Loading */
  .loading-screen {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:#fff; color:#111; flex-direction:column; gap:20px;
  }
  .loader {
    border:4px solid #e5e7eb; border-top:4px solid #0284c7;
    border-radius:50%; width:60px; height:60px;
    animation:spin 1s linear infinite;
  }
  @keyframes spin { 100% { transform:rotate(360deg); } }

  /* Success */
  .success-screen {
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:#f0fdf4; color:#166534; text-align:center; padding:20px;
  }
  .success-icon {
    font-size:60px; margin-bottom:16px; animation:bounce 0.6s ease;
  }
  @keyframes bounce {
    0%{ transform:scale(0.3); opacity:0; }
    50%{ transform:scale(1.1); opacity:1; }
    100%{ transform:scale(1); }
  }
  .btn-back {
    margin-top:20px; padding:12px 24px; border:0; border-radius:12px;
    background:#0284c7; color:#fff; font-size:16px; cursor:pointer;
  }
</style>
</head>
<body>
  
  <!-- Scanner -->
  <div id="scannerScreen" class="scanner">
    <div class="scanner-bar">
      <div class="scanner-title">QRIS Scanner</div>
      <div style="display:flex; gap:10px;">
        <button id="uploadBtn" class="btn-icon">üìÅ</button>
        <button id="switchBtn" class="btn-icon">üîÑ</button>
        <button id="flashBtn" class="btn-icon">üî¶</button>
      </div>
    </div>
    <div class="preview">
      <video id="video" playsinline muted></video>
      <div class="scan-frame"><div class="scan-line"></div></div>
    </div>
  </div>

  <!-- Payment -->
  <div id="paymentScreen" class="payment-screen hidden">
    <div class="payment-header">
      <h2>Konfirmasi Pembayaran</h2>
      <p id="merchantInfo">Merchant</p>
    </div>
    <div class="payment-body">
      <div class="merchant-box">
        <div class="merchant-name" id="merchantName">Merchant</div>
        <div class="merchant-price" id="merchantPrice">Rp0</div>
        <input type="number" id="customAmount" class="custom-input hidden" placeholder="Masukkan nominal" />
      </div>
      <div class="saldo-box">Saldo DANA: Rp2.814 (Isi Saldo)</div>
      <button id="payBtn" class="btn-pay">BAYAR</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingScreen" class="loading-screen hidden">
    <div class="loader"></div>
    <div>Memproses pembayaran...</div>
  </div>

  <!-- Success -->
  <div id="successScreen" class="success-screen hidden">
    <div class="success-icon">‚úÖ</div>
    <h2>Pembayaran Berhasil</h2>
    <p id="paidInfo">Rp0 sudah dibayarkan</p>
    <button id="backBtn" class="btn-back">Kembali ke Scanner</button>
  </div>



<div class="saldo-box" id="saldoContainer">
  Saldo DANA: Rp0
  <button id="topupBtn" class="btn-topup">+ Isi Saldo</button>
</div>

<!-- Modal Top Up -->
<div id="topupModal" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,.6);
  display:flex; align-items:center; justify-content:center;
  z-index:100;
">
  <div style="background:#fff; color:#111; padding:20px; border-radius:14px; width:80%; max-width:320px; text-align:center;">
    <h3 style="margin-bottom:12px;">Isi Saldo</h3>
    <input id="topupAmount" type="number" placeholder="Masukkan nominal" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:12px;"/>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button id="cancelTopup" class="btn" style="background:#aaa; color:#fff;">Batal</button>
      <button id="confirmTopup" class="btn" style="background:#2563eb; color:#fff;">Isi</button>
    </div>
  </div>
</div>


  
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
  
            const video = document.getElementById('video');
const scannerScreen = document.getElementById('scannerScreen');
const paymentScreen = document.getElementById('paymentScreen');
const loadingScreen = document.getElementById('loadingScreen');
const successScreen = document.getElementById('successScreen');
const merchantName = document.getElementById('merchantName');
const merchantPrice = document.getElementById('merchantPrice');
const merchantInfo = document.getElementById('merchantInfo');
const customAmount = document.getElementById('customAmount');
const payBtn = document.getElementById('payBtn');
const backBtn = document.getElementById('backBtn');
const uploadBtn = document.getElementById('uploadBtn');
const switchBtn = document.getElementById('switchBtn');
const flashBtn = document.getElementById('flashBtn');
const saldoBox = document.getElementById('saldoContainer'); // ambil saldo box baru
const paidInfo = document.getElementById('paidInfo');

// Topup
const topupBtn = document.getElementById("topupBtn");
const topupModal = document.getElementById("topupModal");
const topupAmount = document.getElementById("topupAmount");
const confirmTopup = document.getElementById("confirmTopup");
const cancelTopup = document.getElementById("cancelTopup");

let currentStream = null;
let useBackCamera = true;
let scanInterval;
let track;
let torchOn = false;
let lastData = "";
let saldo = 50000; // saldo awal Rp50.000

function updateSaldoBox(){
  saldoBox.firstChild.textContent =
    "Saldo DANA: Rp" + new Intl.NumberFormat("id-ID").format(saldo) + " ";
}

function parseQRIS(data){
  const result = {};
  let i = 0;
  while(i < data.length){
    const tag = data.substr(i,2);
    const len = parseInt(data.substr(i+2,2));
    const value = data.substr(i+4,len);
    result[tag] = value;
    i += 4+len;
  }
  return result;
}

async function startCamera(){
  stopCamera();
  try{
    const constraints = {
      video:{ facingMode: useBackCamera ? "environment" : "user" }
    };
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = currentStream;
    video.play();
    track = currentStream.getVideoTracks()[0];
    startScan();
  }catch(e){
    alert("Tidak bisa akses kamera: "+e.message);
  }
}

function stopCamera(){
  if(currentStream){
    currentStream.getTracks().forEach(t=>t.stop());
    currentStream = null;
  }
  clearInterval(scanInterval);
}

function startScan(){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  scanInterval = setInterval(()=>{
    if(video.readyState === video.HAVE_ENOUGH_DATA){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const code = jsQR(imgData.data, canvas.width, canvas.height);
      if(code && code.data !== lastData){
        lastData = code.data;
        openPaymentUI(code.data);
      }
    }
  },500);
}

function openPaymentUI(data){
  stopCamera();
  scannerScreen.classList.add("hidden");
  paymentScreen.classList.remove("hidden");

  const parsed = parseQRIS(data);
  const name = parsed["59"] || "Merchant Tidak Dikenal";
  const amount = parsed["54"]; 

  merchantName.textContent = name;
  merchantInfo.textContent = name+" | JAKARTA";

  if(amount){
    merchantPrice.textContent = "Rp"+ new Intl.NumberFormat("id-ID").format(parseInt(amount));
    merchantPrice.dataset.value = parseInt(amount);
    customAmount.classList.add("hidden");
  }else{
    merchantPrice.textContent = "Nominal bebas (isi manual)";
    merchantPrice.dataset.value = 0;
    customAmount.classList.remove("hidden");
  }

  updateSaldoBox();
  checkSaldo();
}

function checkSaldo(){
  let total = parseInt(merchantPrice.dataset.value || 0);
  if(!customAmount.classList.contains("hidden") && customAmount.value){
    total = parseInt(customAmount.value);
  }
  if(total > 0){
    if(total > saldo){
      payBtn.disabled = true;
      payBtn.textContent = "Saldo tidak cukup";
    }else{
      payBtn.disabled = false;
      payBtn.textContent = "BAYAR";
    }
  }else{
    payBtn.disabled = true;
    payBtn.textContent = "Masukkan nominal";
  }
}

customAmount.addEventListener('input', checkSaldo);

payBtn.addEventListener('click', ()=>{
  let finalAmount = merchantPrice.dataset.value || 0;
  if(!customAmount.classList.contains("hidden") && customAmount.value){
    finalAmount = parseInt(customAmount.value);
  }
  if(finalAmount > saldo) return; // guard

  saldo -= finalAmount;
  updateSaldoBox();

  paymentScreen.classList.add("hidden");
  loadingScreen.classList.remove("hidden");
  setTimeout(()=>{
    loadingScreen.classList.add("hidden");
    successScreen.classList.remove("hidden");
    paidInfo.textContent = "Rp"+ new Intl.NumberFormat("id-ID").format(finalAmount)+" sudah dibayarkan ke "+merchantName.textContent;
  },2000);
});

backBtn.addEventListener('click', ()=>{
  successScreen.classList.add("hidden");
  scannerScreen.classList.remove("hidden");
  startCamera();
  lastData = "";
});

switchBtn.addEventListener('click', ()=>{
  useBackCamera = !useBackCamera;
  startCamera();
});

flashBtn.addEventListener('click', ()=>{
  if(track && track.getCapabilities().torch){
    torchOn = !torchOn;
    track.applyConstraints({ advanced: [{torch: torchOn}] });
  }else{
    alert("Flash tidak didukung di device ini.");
  }
});

uploadBtn.addEventListener('click', ()=>{
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.onchange = ()=>{
    const file = fileInput.files[0];
    if(!file) return;
    const img = new Image();
    const reader = new FileReader();
    reader.onload = ()=>{
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width; canvas.height = img.height;
        ctx.drawImage(img,0,0);
        const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imgData.data, canvas.width, canvas.height);
        if(code) openPaymentUI(code.data);
        else alert("Tidak ada QR terdeteksi.");
      }
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  };
  fileInput.click();
});

// TOP UP
topupBtn.addEventListener("click", ()=>{
  topupModal.classList.remove("hidden");
});

cancelTopup.addEventListener("click", ()=>{
  topupModal.classList.add("hidden");
  topupAmount.value = "";
});

confirmTopup.addEventListener("click", ()=>{
  const amt = parseInt(topupAmount.value);
  if(isNaN(amt) || amt <= 0){
    alert("Nominal tidak valid");
    return;
  }
  saldo += amt;
  updateSaldoBox();
  topupModal.classList.add("hidden");
  topupAmount.value = "";
  checkSaldo();
  alert("Saldo berhasil ditambahkan Rp"+ new Intl.NumberFormat("id-ID").format(amt));
});

// auto start
updateSaldoBox();
startCamera();
  
</script>
</body>
</html>
